const path=require("path"),fs=require("fs/promises"),sharp=require("sharp"),THUMBNAIL_PREFIX="thumb_",RUNTIME_SCRIPT="\n  document.addEventListener('DOMContentLoaded', function() {\n    // 处理 <img> 标签\n\n    function loadOriginalImages() {\n      const images = document.querySelectorAll('img');\n\n      images.forEach(img => {\n        const src = img.src;\n        // 检查是否是缩略图路径\n        if (!src.includes('thumb_')) return;\n\n        // 已经加载过的不再处理\n        if (img.dataset.loaded === 'true') return;\n\n        // 计算原图路径（去掉 thumb_ 前缀）\n        const originalSrc = src.replace(new RegExp('thumb_', 'g'), '');\n\n        // 先尝试从浏览器缓存直接加载原图\n        const cacheTest = new Image();\n        cacheTest.onload = function () {\n          // 缓存命中：直接替换，无闪屏\n          img.src = originalSrc;\n          img.dataset.loaded = 'true';\n        };\n        cacheTest.onerror = function () {\n          // 缓存未命中：走缩略图→原图过渡\n          // 创建原图加载\n          const tempImg = new Image();\n          tempImg.onload = function() {\n            // 加载成功：先模糊，再替换成原图，再取消模糊\n            img.style.filter = 'blur(0px)';\n            img.src = originalSrc;\n            img.dataset.loaded = 'true';\n          };\n          tempImg.onerror = function () {\n            console.error('Failed to load image:', originalSrc);\n            img.style.filter = 'none';\n          };\n          tempImg.src = originalSrc;\n\n          // 添加过渡效果\n          img.style.transition = 'filter 0.2s ease';\n          img.style.filter = 'blur(2px)';\n        };\n        cacheTest.src = originalSrc; // 触发缓存检测\n      });\n    }\n\n    // 处理 CSS background-image\n    function loadOriginalBackgrounds() {\n      const elements = document.querySelectorAll('*');\n      elements.forEach(el => {\n        if (el.dataset.bgLoaded === 'true') return;\n\n        const bgImage = window.getComputedStyle(el).backgroundImage;\n        if (!bgImage.includes('thumb_')) return;\n\n        // 用正则把 url(...) 中的路径提出来\n        const urlMatch = bgImage.match(/url\\([\"']?(.*?)[\"']?\\)/i);\n        if (!urlMatch) return;\n\n        const thumbPath = urlMatch[1];\n        const originalBg = thumbPath.replace(new RegExp(THUMBNAIL_PREFIX), '');\n\n        const tempImg = new Image();\n        tempImg.onload = function() {\n          // 替换背景图\n          el.style.backgroundImage = bgImage.replace(thumbPath, originalBg);\n          el.dataset.bgLoaded = 'true';\n        };\n        tempImg.onerror = function() {\n          console.error('Failed to load background image:', originalBg);\n        };\n        tempImg.src = originalBg;\n      });\n    }\n\n    // 页面初次加载\n    loadOriginalImages();\n    loadOriginalBackgrounds();\n\n    // 监听后续动态插入的 DOM\n    const observer = new MutationObserver(function(mutations) {\n      mutations.forEach(function(mutation) {\n        if (mutation.addedNodes.length) {\n          loadOriginalImages();\n          loadOriginalBackgrounds();\n        }\n      });\n    });\n    observer.observe(document.body, { childList: true, subtree: true });\n  });\n";function thumbnailLoading(n={}){const e={quality:30,width:50,height:null,skipSmallImages:!0,minSizeToResize:30,format:"auto",blurAmount:2,transitionDuration:"0.3s",...n};return{name:"vite-plugin-image-thumbnail",async generateBundle(n,t){const a=[];for(const[n,i]of Object.entries(t))/\.(jpg|png|jpeg|webp|avif|gif)$/i.test(n)&&a.push((async()=>{try{const t="asset"===i.type?i.source:await fs.readFile(i.fileName),a=t.length/1024;if(e.skipSmallImages&&a<=e.minSizeToResize)return;const r="thumb_"+path.basename(n),o=path.join(path.dirname(n),r);let s=sharp(t).resize({width:e.width,height:e.height,fit:"inside",withoutEnlargement:!0});switch(e.format){case"png":s=s.png({quality:e.quality});break;case"webp":s=s.webp({quality:e.quality});break;case"jpeg":s=s.jpeg({quality:e.quality});break;default:s=n.toLowerCase().endsWith(".png")?s.png({quality:e.quality}):n.toLowerCase().endsWith(".webp")?s.webp({quality:e.quality}):s.jpeg({quality:e.quality})}this.emitFile({type:"asset",fileName:o,source:await s.toBuffer()})}catch(e){console.error(`Failed to generate thumbnail for ${n}:`,e)}})());await Promise.all(a)},renderChunk:n=>n.replace(/(const\s+\w+\s*=\s*["'])(.*?\.(jpg|png|jpeg|webp|avif|gif))(["'])/gi,(n,e,t,a,i)=>{const r=function(n){const e=path.basename(n),t=path.dirname(n);return path.posix.join(t,"thumb_"+e).replace(/\\/g,"/")}(t);return`${e}${r}${i}`}),transformIndexHtml:n=>({html:n,tags:[{tag:"script",injectTo:"body",children:RUNTIME_SCRIPT.replace(/'blur\(2px\)'/,`'blur(${e.blurAmount}px)'`).replace(/0\.3s/g,e.transitionDuration)}]})}}module.exports=thumbnailLoading;